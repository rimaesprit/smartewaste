{% extends 'BackBase.html.twig' %}

{% block title %}Gestion des réclamations{% endblock %}

{% block body %}
    <div class="container-fluid">
        <h1 class="h3 mb-2 text-gray-800">Gestion des réclamations</h1>
        <p class="mb-4">Gérez ici toutes les réclamations soumises par les utilisateurs de l'application.</p>

        {% for message in app.flashes('success') %}
            <div class="alert alert-success">
                {{ message }}
            </div>
        {% endfor %}

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Liste des réclamations</h6>
            </div>
            <div class="card-body">
                <!-- Formulaire de recherche -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-search"></i> Recherche avancée</h6>
                            </div>
                            <div class="card-body">
                                <form id="searchForm" method="get" action="{{ path('app_admin_reclamation_search') }}">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label for="query">Recherche par texte</label>
                                            <input type="text" class="form-control" id="query" name="query" placeholder="Rechercher...">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="status">État</label>
                                            <select class="form-control" id="status" name="status">
                                                <option value="">Tous</option>
                                                <option value="Pending">En attente</option>
                                                <option value="In Progress">En traitement</option>
                                                <option value="Resolved">Résolu</option>
                                                <option value="Rejected">Rejeté</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="type">Type</label>
                                            <select class="form-control" id="type" name="type">
                                                <option value="">Tous</option>
                                                <option value="Technique">Technique</option>
                                                <option value="Service">Service</option>
                                                <option value="Autre">Autre</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="fromDate">Date de début</label>
                                            <input type="date" class="form-control" id="fromDate" name="fromDate">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="toDate">Date de fin</label>
                                            <input type="date" class="form-control" id="toDate" name="toDate">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <button type="submit" class="btn btn-primary mr-2"><i class="fas fa-search"></i> Rechercher</button>
                                            <button type="button" id="resetSearch" class="btn btn-secondary"><i class="fas fa-undo"></i> Réinitialiser</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered" id="reclamationsTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Utilisateur</th>
                                <th>Type</th>
                                <th>État</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reclamationsTableBody">
                            {% include 'admin/reclamation/_reclamations_list.html.twig' with {'reclamations': reclamations} %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function() {
            // Gestionnaire pour le formulaire de recherche
            $('#searchForm').on('submit', function(e) {
                e.preventDefault();
                searchReclamations();
            });

            // Réinitialisation de la recherche
            $('#resetSearch').on('click', function() {
                $('#searchForm')[0].reset();
                searchReclamations();
            });

            // Fonction pour effectuer la recherche via AJAX
            function searchReclamations() {
                var query = $('#query').val();
                var status = $('#status').val();
                var type = $('#type').val();
                var fromDate = $('#fromDate').val();
                var toDate = $('#toDate').val();

                var url = "{{ path('app_admin_reclamation_search') }}";
                var params = [];
                
                if (query) params.push('query=' + encodeURIComponent(query));
                if (status) params.push('status=' + encodeURIComponent(status));
                if (type) params.push('type=' + encodeURIComponent(type));
                if (fromDate) params.push('fromDate=' + encodeURIComponent(fromDate));
                if (toDate) params.push('toDate=' + encodeURIComponent(toDate));
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(data) {
                        $('#reclamationsTableBody').html(data);
                    },
                    error: function(xhr, status, error) {
                        console.error('Erreur AJAX:', error);
                        alert('Une erreur est survenue lors de la recherche.');
                    }
                });
            }
        });
    </script>
{% endblock %} 